name: Sync Env to Hugging Face
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight

jobs:
  sync-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install huggingface_hub

      - name: Sync environment variables to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          CONTINUE_API_KEY: ${{ secrets.CONTINUE_API_KEY }}
          ALIBABA_QWEN_API_KEY: ${{ secrets.ALIBABA_QWEN_API_KEY }}
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          CODECOPILOT_KEY: ${{ secrets.CODECOPILOT_KEY }}
        run: |
          python - <<'EOF'
          import os
          from huggingface_hub import HfApi

          # Initialize the API
          api = HfApi(token=os.environ['HF_TOKEN'])
          
          # Get username from secrets
          username = os.environ['HF_USERNAME']
          space_name = f"{username}/agent4-implementation"
          
          # Define variables to sync
          variables = {
              'CONTINUE_API_KEY': os.environ.get('CONTINUE_API_KEY', ''),
              'ALIBABA_QWEN_API_KEY': os.environ.get('ALIBABA_QWEN_API_KEY', ''),
              'KIMI_API_KEY': os.environ.get('KIMI_API_KEY', ''),
              'CODECOPILOT_KEY': os.environ.get('CODECOPILOT_KEY', ''),
              'NODE_ENV': 'production',
              'PORT': '3000',
              'DEFAULT_LLM_PROVIDER': 'continue',
              'FALLBACK_ORDER': 'continue,alibaba,kimi,codestral'
          }
          
          # Update each variable
          for key, value in variables.items():
              try:
                  api.add_space_variable(
                      repo_id=space_name,
                      key=key,
                      value=value
                  )
                  print(f"Successfully updated {key}")
              except Exception as e:
                  print(f"Error updating {key}: {str(e)}")
          
          print("Environment variables sync completed!")
          EOF
